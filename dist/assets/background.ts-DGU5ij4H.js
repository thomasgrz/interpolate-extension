import{a as w,I as R,l as g}from"./InterpolateStorage-BI30zlBt.js";const f=async a=>{await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:a})},I=async a=>{await chrome.userScripts?.unregister({ids:a})},v=async(a,r)=>{const{onError:i}=r,o=await chrome.declarativeNetRequest.getDynamicRules(),c=a?.reduce((t,s)=>s?.enabledByUser?{...t,enabledRules:[...t?.enabledRules??[],s]}:{...t,pausedRules:[...t?.pausedRules??[],s]},{enabledRules:[],pausedRules:[]}),e=o?.filter(t=>c?.pausedRules?.some(s=>s.details.id===t.id));e?.length&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:e?.map(t=>t.id)});const n=c?.enabledRules?.filter(t=>!o.some(s=>s.id===t.details.id));if(n?.length)try{const t=n?.map(s=>new Promise(async(u,p)=>{try{await chrome.declarativeNetRequest.updateDynamicRules({addRules:[s.details]}),u({id:s.details.id,status:"fulfilled"})}catch(y){i?.(s?.details?.id,y),p({id:s.details.id,status:"rejected",reason:y})}}));await Promise.allSettled(t)}catch{}},T=async a=>{const r=await chrome.userScripts?.getScripts()??[],i=a?.reduce((e,n)=>n?.enabledByUser?{...e,enabledScripts:[...e?.enabledScripts??[],n]}:{...e,pausedScripts:[...e?.pausedScripts??[],n]},{enabledScripts:[],pausedScripts:[]}),o=r?.filter?.(e=>i?.pausedScripts?.some(n=>n?.details?.id===e?.id));await chrome.userScripts?.unregister({ids:[...o?.map(e=>e.id)]});const c=a?.filter(e=>!r?.find(s=>s?.id===e?.details.id));c?.length&&await chrome.userScripts.register([...c?.map(e=>e.details)])},m={addUserScripts:w,removeDynamicRulesById:f,removeUserScriptsById:I,updateDynamicRules:v,updateUserScripts:T},U=async()=>{const a=(e,n)=>{const{type:t}=n;switch(t){case"headers":case"redirect":e.dynamicRules.push(n);break;case"script":e.userScripts.push(n);break}return e},r=async e=>{const{dynamicRules:n,userScripts:t}=e.reduce(a,{dynamicRules:[],userScripts:[]});await m.updateUserScripts(t),await m.updateDynamicRules(n,{onError:(s,u)=>{R.setInterpolationError(s,u)}})},i=async e=>{const{dynamicRules:n,userScripts:t}=e.reduce(a,{dynamicRules:[],userScripts:[]}),s=t.map(p=>p.details.id);await chrome.userScripts?.unregister({ids:s});const u=n.map(p=>p.details.id);await m.removeDynamicRulesById(u),await m.removeUserScriptsById(s)},o=async e=>{const{userScripts:n}=e.reduce(a,{dynamicRules:[],userScripts:[]}),t=n.map(s=>s.details);await m.addUserScripts(t)},c=async e=>{try{const n=!!e.updated.length,t=!!e.removed.length,s=!!e.created.length;n&&await r(e.updated),t&&await i(e.removed),s&&await o(e.created)}catch(n){g(`syncAllInterpolationsWithStorage resulted with error: ${n}`)}};R.subscribeToInterpolationChanges(async e=>{await c(e)})},h=new Set,l=async({requestId:a,tabId:r,url:i,headers:o,matchingInterpolation:c})=>{g("Continuing request in tab: "+r+" for request with id "+a),chrome.debugger.sendCommand({tabId:r},"Fetch.continueRequest",{requestId:a,...i?{url:i}:{},...o?{headers:o}:{}}),c&&chrome.tabs.sendMessage(r,c)};try{chrome.tabs.onRemoved.addListener(r=>{h.delete(r)});const a=()=>{chrome.debugger.onEvent.addListener(async(r,i,o)=>{if(i==="Target.attachedToTarget"){const c={...r,sessionId:o?.sessionId};return g("Target.attachedToTarget",c),chrome.debugger.sendCommand(c,"Fetch.enable")}})};chrome.debugger.onEvent.addListener(async(r,i,o)=>{if(i!=="Fetch.requestPaused")return;const{tabId:e}=r,{request:n,requestId:t}=o??{},{url:s}=n,u=await R.getAllByTypes(["redirect","headers"]);if(!u?.length)return l({requestId:t,tabId:e,url:s});if(n?.url?.startsWith("chrome-extension"))return l({requestId:t,tabId:e,url:s});if(!h.has(e))return l({requestId:t,tabId:e,url:s});const d=u.find(b=>{const S=b?.details?.condition?.regexFilter;return S?new RegExp(S).test(s):!1});if(!d)return l({tabId:e,requestId:t,url:s});if(!d.enabledByUser)return l({tabId:e,requestId:t,url:s});switch(d?.type){case"headers":return l({matchingInterpolation:d,headers:[{name:d?.details?.action?.requestHeaders?.[0]?.header,value:d?.details?.action?.requestHeaders?.[0]?.value}],tabId:e,requestId:t,url:d?.details?.action?.redirect?.url});case"redirect":return l({matchingInterpolation:d,tabId:e,requestId:t,url:d?.details?.action?.redirect?.url});default:return l({tabId:e,requestId:t,url:s})}return l({tabId:e,requestId:t,url:d?.details?.action?.redirect?.url})}),chrome.tabs.onUpdated.addListener(async r=>{h.has(r)||(console.count("tabId onUpdated setup logic called for: "+r),chrome.debugger.attach({tabId:r},"1.3"),a(),h.add(r),chrome.debugger.sendCommand({tabId:r},"Fetch.enable"))}),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(r=>console.error(r)),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"openSidePanel",title:"Open Interpolate panel",contexts:["all"]}),U()}),chrome.contextMenus.onClicked.addListener((r,i)=>{r.menuItemId==="openSidePanel"&&i?.windowId&&chrome.sidePanel.open({windowId:i?.windowId})})}catch(a){g("Error in background.ts",a)}
