const g=(...t)=>{console.info("[Interpolate Chrome Extension] ",...t)},f="interpolate-selected-form",h="interpolation-config-";class p{createdAt;enabledByUser;error;name;constructor(e){this.createdAt=Date.now(),this.enabledByUser=!0,this.error=null,this.name=e.name}}class w extends p{details;type;constructor(e){super(e),this.type="script",this.details=e.details}}class A extends p{details;type;constructor(e){super(e),this.type="redirect",this.details=e.details}}class v extends p{details;type;constructor(e){super(e),this.type="headers",this.details=e.details}}const b=()=>Math.floor(Math.random()*5e3),m=t=>new w({name:t.name,details:{js:[{code:`${t.body}`}],id:b().toString(),matches:[t.matches||"*://*/*"]}}),R=async t=>{await(async()=>{try{await chrome.userScripts?.register(t)}catch(r){console.error("Error registering user scripts atomically, attempting to register individually:",r);for(const s of t)try{await chrome.userScripts?.register([s])}catch(o){console.error(`Failed to register script with id ${s.id}:`,o)}}})()},S={logInvocation(t){g(`(invocation): ${t}`)},logError(t,e){g(`${t} threw (error): `,e)},async create(t){const e="create";this.logInvocation(e);try{await this.setInterpolations(Array.isArray(t)?t:[t])}catch(r){this.logError(e,r)}},async createRollbackRecords(t){const e="createRollbackRecord";this.logInvocation(e);let r;try{const s=t.reduce((o,n)=>({...o,[this.getRollbackRecordKey(n.id)]:{...n}}),{});r=await chrome.storage?.sync?.set(s)}catch(s){this.logError(e,s)}return r},async disableAll(){const t="disableAll";this.logInvocation(t);try{const e=await this.getAllInterpolations();if(!e)return;const r=e?.map(o=>({action:"pause",id:o?.details?.id,before:o,after:{...o,enabledByUser:!1}}));await this.createRollbackRecords(r);const s=e?.map(o=>({...o,enabledByUser:!1}));await this.setInterpolations(s)}catch(e){this.logError(t,e)}},async deleteAll(){const t="deleteAll";this.logInvocation(t);try{return chrome.storage?.sync?.clear()}catch(e){this.logError(t,e)}},async delete(t){const e="delete";this.logInvocation(e);try{let r=[];Array.isArray(t)?r=t.map(s=>this.getInterpolationRecordKey(s)):r=[this.getInterpolationRecordKey(t)],await chrome.storage?.sync?.remove(r)}catch(r){this.logError(e,r)}},async enableAll(){const t="enableAll";this.logInvocation(t);try{const e=await this.getAllInterpolations();if(!e)return;const r=e?.map(o=>({action:"resume",id:o?.details?.id,before:o,after:{...o,enabledByUser:!0}}));await this.createRollbackRecords(r);const s=e?.map(o=>({...o,enabledByUser:!0}));await this.setInterpolations(s)}catch(e){this.logError(t,e)}},async getAllMatchingPatterns(){return(await this.getAllByTypes(["redirect"]))?.map(r=>r?.details?.condition?.regexFilter)},getInterpolationRecordKey(t){return typeof t=="string"&&t?.startsWith("interp")?t:`${h}${t}`},getRollbackRecordKey(t){return`rollback-record-${this.getInterpolationRecordKey(t)}`},async getInterpolationById(t){const e=this.getInterpolationRecordKey(t);return(await chrome.storage?.sync?.get(e))[e]},async getAllByTypes(t){const e="getAllByTypes";let r;try{return r=await this.getAllInterpolations(),r?.filter(s=>t.includes(s?.type))}catch(s){this.logError(e,s)}},async getAllInterpolations(){const t="getAllInterpolations";try{const r=(await chrome.storage?.sync?.getKeys()).filter(n=>n.startsWith(h)),s=await chrome.storage?.sync?.get(r),o=Object.values(s).reduce((n,l)=>(l&&!Array.isArray(l)&&typeof l=="object"&&Object.hasOwn(l,"type")&&Object.hasOwn(l,"details")&&n.push(l),n),[]);return o.length?o:[]}catch(e){this.logError(t,e)}},async setInterpolationError(t,e){const r="setInterpolationError";try{const o={...await this.getInterpolationById(t),error:typeof e=="object"?e.message:e};await this.setInterpolations([o])}catch(s){this.logError(r,s)}},async setInterpolations(t){if(this.logInvocation("set"),!t)return;const r=t.reduce((s,o)=>o&&!Array.isArray(o)&&typeof o=="object"?{...s,[this.getInterpolationRecordKey(o.details.id)]:o}:s,{});try{await chrome.storage?.sync?.set({...r})}catch(s){this.logError("set",s)}},async setIsEnabled(t,e){const r="setIsEnabled";this.logInvocation(r);const s=await this.getInterpolationById(t);try{await this.createRollbackRecords([{action:e?"resume":"pause",id:s?.details?.id,before:s,after:{...s,enabledByUser:e}}]),await this.setInterpolations([{...s,enabledByUser:e}])}catch(o){this.logError(r,o)}},async subscribeToRecentlyInvoked(t){this.logInvocation("subscribeToRecentlyInvoked");try{chrome.storage?.sync?.onChanged.addListener(async r=>{if(this.logInvocation("chrome.storage?.sync?.onChanged"),!Object.hasOwn(r,"recentlyInvoked"))return;const s=r.recentlyInvoked,{newValue:o}=s;t({recentlyInvoked:JSON.parse(o)})})}catch{}},async subscribeToInterpolationChanges(t){const e="subscribeToChanges";this.logInvocation(e);try{chrome.storage?.sync?.onChanged.addListener(async r=>{this.logInvocation("chrome.storage?.sync?.onChanged");const s=Object.entries(r)?.reduce((o,n)=>{const[l,i]=n;if(l.startsWith(h)){if(!Object.hasOwn(i,"oldValue"))return o.created.push(i.newValue),o;if(Object.hasOwn(i,"oldValue")&&Object.hasOwn(i,"newValue"))return o.updated.push(i.newValue),o;Object.hasOwn(i,"oldValue")&&!i.newValue&&o.removed.push(i.oldValue)}return o},{created:[],updated:[],removed:[]});t(s)})}catch(r){this.logError(e,r)}},async syncWithUserScripts(){const t="syncWithUserScripts",e=await this.getAllByTypes(["script"]),r=new Map(e?.map(s=>[s.details.id,s]));try{const o=(await chrome?.userScripts?.getScripts()).reduce((a,c)=>{const d=c.id,I=r.get(d);return a.add(I??m({body:c.js?.[0]?.code??"",name:"unknown-"+d,matches:c?.matches?.[0],runAt:c?.runAt})),a},new Set),n=r.entries().reduce((a,c)=>{const[,d]=c;return a.add(d),a},new Set),i=o.difference(n).entries().reduce((a,c)=>(a.push(c[0]),a),[]);await this.create(i);const y=n.difference(o)?.entries?.().reduce((a,c)=>(a.push(c[0].details),a),[]);await R(y)}catch(s){this.logError(t,s)}},async syncAll(){return Promise.allSettled([this.syncWithUserScripts()])}};export{v as H,S as I,A as R,R as a,f as b,m as c,b as g,g as l};
